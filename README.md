### Настройка проекта

##### Устанавливаем poetry (см. документацию https://python-poetry.org/docs/#installing-with-the-official-installer)
##### git clone https://github.com/Spaceoceanoutlook/TestForPatres.git
cd TestForPatres/
##### Создаем и активируем виртуального окружения
poetry install

poetry env activate

##### Если после этой команды вернулась "source /путь/", значит виртуальное окружение не активировалось
##### (зависит от версии poetry). Нужно скопировать этот путь и нажать Enter.
##### Создаем БД Postgres
##### Для запуска локального Postgres:
create_db.py
##### Для запуска Postgres в Docker:
docker run --name my_postgres -e POSTGRES_PASSWORD=postgres -p 5432:5432 -d postgres

create_db.py
##### Применяем миграции 
alembic upgrade head
##### Переходим в папку проекта 
cd testforpatres/
##### Запускаем 
python3 main.py (для Linux)

По адресу http://localhost:8000/docs зарегистрируемся в /auth/register, 
аутентифицируемся в /auth/login, получаем в ответе JWT-токен. 
Используем его для защищенных эндпоинтов. Получение списка всех книг не защищен, 
чтобы читатель мог просмотреть доступные книги и потом принять решение о регистрации.

### Структура базы данных:
Решения по структуре базы данных принимались исходя из технического задания.

**User**: email, пароль (хешированный) - для авторизации.

**Book**: хранит данные книги и имеет связь с таблицей borrowed_books.

**Reader**: хранит данные читателя и также имеет связь с таблицей borrowed_books.

**BorrowedBook**: таблица связей — отслеживает, кто и когда взял какую книгу.
Имеет доступ к информации об объектах (книгах и читателях).


### Объяснение бизнес-логики
Бизнес-логика реализована в файле crud/borrowed.py.
Сложность была том, чтобы продумать работающую логику проверок.

##### Отсутствие экземпляров (4.1)
При попытке взять книгу происходит проверка наличия свободных экземпляров через поле copies_available 
модели Book.
Если книг в наличии нет (copies_available < 1), выдача книги блокируется и функция возвращает None.

##### Ограничение на количество книг (4.2)
В функции borrow_book сначала считается, сколько книг читатель уже взял и не вернул (фильтрация по 
return_date.is_(None). Если читатель уже имеет максимальное количество взятых книг (MAX_BORROWED_BOOKS = 3), 
выдача новой книги не происходит и функция возвращает None.

##### Нельзя вернуть книгу, которая не была выдана этому читателю или уже возвращена. (4.3)
Функция return_book ищет активную запись выдачи книги (с return_date = None) для конкретного читателя и книги.
Если запись найдена, у неё проставляется дата возврата — текущее время UTC.
Количество доступных экземпляров книги увеличивается (copies_available += 1).
После этого изменения сохраняются в базе.

### Аутентификация
Использована библиотека python-jose для создания и валидации JWT.
Пароли хэшируются через passlib[bcrypt]. 
Эти библиотеки выбраны, как наиболее используемые для аутентификации и хэширования.
Функции для хэширования пароля и генерации токена лежат в security.py, а проверки и выдача токена
происходит при выполнении эндпоинта auth/login.
Используется HTTPBearer из FastAPI — токен передаётся в заголовке Authorization: Bearer <token>.
Все эндпоинты защищены зависимостью get_current_user, кроме получения списка всех книг, 
так как во всех эндпоинтах содержится пользовательская непубличная информация.

### Новая фича (на уровне идеи)
Эндпоинт для списка самых популярных книг.
Позволяет библиотекарю выявлять книги, которые пользуются большим спросом и пополнять количество их копий. 
Для реализации можно сделать запрос в базу, который группирует таблицу BorrowedBook по book_id и 
считает количество записей (сколько раз каждая книга была взята).

### Тесты
Запуск

pytest tests/

Для простоты реализации тестов была использована база данных SQLite.
Написаны тесты:
1. **test_borrow_book_success** - книга выдается, если у неё есть доступные экземпляры
и у читателя нет лимитных ограничений.
2. **test_borrow_book_no_copies** - книга не выдается, если нет экземпляров.
3. **test_borrow_book_limit_exceeded** - читатель не может взять более 3 книг.
4. **test_protected_endpoint_access** - регистрирует и логинит нового пользователя с уникальным email,
получает JWT токен. Проверяет, что доступ к списку книг разрешён без токена.
Проверяет, что доступ к списку читателей без токена запрещён, а с токеном разрешен.

